steps:
# Step 1: Clone the repository from GitHub
- name: 'gcr.io/cloud-builders/git'
  args: ['clone', 'https://github.com/RanjithKuraya/TEMCICD.git']

# Step 2: Build the Docker image with an auto-generated tag using SHORT_SHA
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'europe-west3-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:$_SHORT_SHA','./TEMCICD/']

# Step 3: Push the Docker image to the container registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'europe-west3-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:$_SHORT_SHA']

# Step 4: Update the Kubernetes deployment to use the newly built Docker image with the tag SHORT_SHA
- name: 'gcr.io/cloud-builders/kubectl'
  args: [
    'set',
    'image',
    'deployment',
    'deployment-1',
    'cicdtem-sha256-1=europe-west3-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:$_SHORT_SHA'
    ]
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=europe-west3'
  - 'CLOUDSDK_CONTAINER_CLUSTER=cicd-deploy1'
    
options:
  logging: CLOUD_LOGGING_ONLY  # Or use NONE if you don't want any logging.

# Substitutions for the project and image name
substitutions:
  _IMAGE_NAME: 'cicdtem'
  _PROJECT_ID: 'glb-fs-wgh-app-dev'
  _SHORT_SHA: 'v3'
  _REPO_NAME: 'cicdtem'
